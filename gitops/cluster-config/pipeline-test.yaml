apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: pipeline-test
  namespace: gitops
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec: 
  params:
  - name: TARGET_VERSION
    type: string
    default: v1.0.1
  - name: TEST_URL
    type: string
    default: http://istio-ingressgateway-istio-system.apps.cluster-lsxh6.lsxh6.sandbox1300.opentlc.com/products  
  - name: JQ_PATH
    type: string
    default: .metadata
    #'.products[0].discountInfo.metadata'

  workspaces:
  - name: app-source

  tasks:
  - name: get-application-url
    taskRef:
      name: openshift-client
    params:
    - name: SCRIPT
      value: |
        oc get routes -n istio-system istio-ingressgateway  --template='http://{{.spec.host}}/products' > $(workspaces.manifest-dir.path)/url
        cat $(workspaces.manifest-dir.path)/url
    workspaces:
    - name: manifest-dir
      workspace: app-source

  - name: e2e-test-new-image-tag
    runAfter:
    - get-application-url
    params:
      - name: TARGET_VERSION
        value: $(params.TARGET_VERSION)
      - name: JQ_PATH
        value: $(params.JQ_PATH)
    taskRef:
      name: shop-e2e-test
    workspaces:
    - name: source
      workspace: app-source
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: shop-e2e-test
  namespace: gitops
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  params:
  - name: TARGET_VERSION
  - name: JQ_PATH
  steps:
  - name: set-results
    image: badouralix/curl-jq
    script: |
      version="none"
      url= cat $(workspaces.source.path)/url
      sleep 1
      while [[ "$version" != "$(params.TARGET_VERSION)" ]]
      do
        sleep 1
        curl $url | jq -r '$(params.JQ_PATH)' > metadata
        cat metadata
        version=$(jq -r '.version' metadata)
        echo $version
      done
  workspaces:
  - name: source
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  namespace: gitops
  name: aaa
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi


  
